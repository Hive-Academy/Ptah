<div class="chat-container h-full flex flex-col min-w-0">
  <!-- Clean Material Header -->
  <mat-toolbar class="border-b border-divider px-4 flex-shrink-0">
    <div class="session-info flex-1 min-w-0">
      <h3 class="text-base font-medium text-foreground m-0 truncate">
        {{ currentSession()?.name || 'New Session' }}
      </h3>
      @if (workspaceInfo()) {
        <div class="text-xs text-muted-foreground mt-1 truncate">
          {{ workspaceInfo()!.name }} â€¢ {{ workspaceInfo()!.projectType }}
        </div>
      }
    </div>

    <div class="session-actions flex gap-2 flex-shrink-0">
      <button mat-icon-button
        (click)="newSession()"
        title="New Session"
        class="text-muted-foreground hover:text-foreground">
        <lucide-angular [img]="PlusIcon" class="w-5 h-5"></lucide-angular>
      </button>

      <button mat-icon-button
        (click)="switchSession()"
        title="Switch Session"
        class="text-muted-foreground hover:text-foreground">
        <lucide-angular [img]="HistoryIcon" class="w-5 h-5"></lucide-angular>
      </button>

      <button mat-icon-button
        (click)="showSettings()"
        title="Chat Settings"
        class="text-muted-foreground hover:text-foreground">
        <lucide-angular [img]="SettingsIcon" class="w-5 h-5"></lucide-angular>
      </button>
    </div>
  </mat-toolbar>

  <!-- Clean Token Usage Progress Bar with subtle gold accent -->
  @if (currentSession()?.tokenUsage) {
    <mat-progress-bar 
      class="h-1"
      mode="determinate" 
      [value]="currentSession()!.tokenUsage!.percentage"
      [color]="currentSession()!.tokenUsage!.percentage <= 80 ? 'primary' : (currentSession()!.tokenUsage!.percentage <= 90 ? 'accent' : 'warn')"
      style="--mdc-linear-progress-active-indicator-color: #FFD700">
    </mat-progress-bar>
  }

  <!-- Clean Message List -->
  <div class="message-list flex-1 overflow-y-auto p-4 space-y-3 min-h-0" #messageContainer>
    @if (isLoading()) {
      <div class="loading text-center py-8">
        <mat-spinner diameter="32" class="mx-auto mb-4"></mat-spinner>
        <p class="text-muted-foreground">Initializing Claude...</p>
      </div>
    } @else if (messages().length === 0) {
      <div class="welcome-message text-center py-8 space-y-4">
        <div class="text-4xl mb-4">ðŸ’¬</div>
        <h3 class="text-lg font-medium text-foreground">Welcome to Claude</h3>
        <p class="text-muted-foreground max-w-md mx-auto">Ask questions about your code, get help with debugging, or generate documentation.</p>

        <div class="quick-actions flex flex-wrap gap-2 justify-center max-w-md mx-auto">
          <button mat-button
            (click)="sendQuickMessage('Please review the current file for potential improvements.')"
            class="text-sm">
            <mat-icon class="text-base mr-2">code</mat-icon>
            Review Code
          </button>

          <button mat-button
            (click)="sendQuickMessage('Generate unit tests for the current file.')"
            class="text-sm">
            <mat-icon class="text-base mr-2">science</mat-icon>
            Generate Tests  
          </button>

          <button mat-stroked-button
            egyptianButton="papyrus"
            size="small"
            (click)="sendQuickMessage('Find potential bugs and issues in the current code.')"
            class="!text-xs sm:!text-sm !px-3 sm:!px-4 !py-2 !min-h-8 sm:!min-h-10">
            <mat-icon class="!text-base mr-1">search</mat-icon>
            Find Bugs
          </button>
        </div>
      </div>
    } @else {
      @for (message of messages(); track message.id) {
        <div class="message mb-2 sm:mb-3" [class]="'message-' + message.type">
          @if (message.type === 'user') {
            <div class="user-message flex justify-end">
              <mat-card egyptianCard="primary" class="max-w-[90%] sm:max-w-[80%] !bg-blue-600 text-white !p-2 sm:!p-3">
                <mat-card-content class="!p-0">
                  <div class="content text-sm sm:text-base break-words" [innerHTML]="formatMessageContent(message.content)"></div>

                  @if (message.files && message.files.length > 0) {
                    <div class="attached-files mt-2 flex flex-wrap gap-1">
                      @for (file of message.files; track file) {
                        <mat-chip class="!h-6 !text-xs !bg-blue-700 !text-white">
                          <mat-icon matChipAvatar class="!text-sm">description</mat-icon>
                          {{ getFileName(file) }}
                        </mat-chip>
                      }
                    </div>
                  }

                  <div class="message-timestamp text-xs opacity-70 text-right mt-1">
                    {{ formatTimestamp(message.timestamp) }}
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          } @else if (message.type === 'assistant') {
            <div class="assistant-message flex justify-start">
              <mat-card 
                [egyptianCard]="message.isError ? 'warn' : 'accent'" 
                class="max-w-[95%] sm:max-w-[90%] !p-2 sm:!p-3"
                [class.!border-red-300]="message.isError"
                [class.!bg-red-50]="message.isError">
                <mat-card-content class="!p-0">
                  <div class="content text-sm sm:text-base break-words" [innerHTML]="formatMessageContent(message.content)"></div>

                  @if (message.streaming) {
                    <div class="streaming-indicator flex items-center gap-2 mt-2 text-hieroglyph-500">
                      <div class="typing-dots flex gap-1">
                        <span class="w-1 h-1 bg-current rounded-full animate-pulse"></span>
                        <span class="w-1 h-1 bg-current rounded-full animate-pulse typing-dot-2"></span>
                        <span class="w-1 h-1 bg-current rounded-full animate-pulse typing-dot-3"></span>
                      </div>
                      <span class="text-xs">Claude is thinking...</span>
                    </div>
                  }

                  <div class="message-timestamp text-xs opacity-70 text-left mt-1">
                    {{ formatTimestamp(message.timestamp) }}
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          } @else {
            <div class="system-message flex justify-center">
              <div class="message-content bg-hieroglyph-100 text-hieroglyph-700 p-2 rounded text-sm text-center"
                   [class.bg-red-100]="message.isError"
                   [class.text-red-700]="message.isError">
                {{ message.content }}
              </div>
            </div>
          }
        </div>
      }
    }

    @if (isStreaming()) {
      <div class="streaming-placeholder">
        <div class="assistant-message flex justify-start">
          <div class="message-content bg-papyrus-100 border border-hieroglyph-200 p-3 rounded-lg">
            <div class="streaming-indicator flex items-center gap-2 text-hieroglyph-500">
              <div class="typing-dots flex gap-1">
                <span class="w-1 h-1 bg-current rounded-full animate-pulse"></span>
                <span class="w-1 h-1 bg-current rounded-full animate-pulse typing-dot-2"></span>
                <span class="w-1 h-1 bg-current rounded-full animate-pulse typing-dot-3"></span>
              </div>
              <span class="text-sm">Claude is thinking...</span>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Input Area - responsive with Material components -->
  <div class="input-area border-t border-gray-200 bg-gray-50 p-2 sm:p-4 flex-shrink-0">
    <div class="message-input-container flex gap-2 sm:gap-3 items-end">
      <mat-form-field class="flex-1" appearance="outline" egyptianInput="accent">
        <mat-label>Ask Claude about your code...</mat-label>
        <textarea 
          matInput
          [(ngModel)]="currentMessage"
          (keydown)="onKeyDown($event)"
          placeholder="Type your message here..."
          rows="1" 
          cdkTextareaAutosize
          cdkAutosizeMinRows="1"
          cdkAutosizeMaxRows="4"
          [disabled]="isStreaming()"
          class="resize-none !text-sm sm:!text-base"></textarea>
        <mat-icon matSuffix class="text-gray-400">edit</mat-icon>
      </mat-form-field>

      <button mat-fab 
        color="primary"
        egyptianButton="sacred"
        (click)="sendMessage()"
        [disabled]="!canSendMessage()"
        title="Send Message"
        class="!w-10 !h-10 sm:!w-12 sm:!h-12 flex-shrink-0">
        @if (isStreaming()) {
          <mat-spinner diameter="20" color="accent"></mat-spinner>
        } @else {
          <lucide-angular [img]="SendIcon" class="!w-4 !h-4 sm:!w-5 sm:!h-5"></lucide-angular>
        }
      </button>
    </div>

    <!-- Quick Actions - responsive with Material buttons -->
    <div class="quick-actions mt-2 sm:mt-3 flex flex-wrap gap-1 sm:gap-2">
      <button mat-stroked-button
        size="small"
        egyptianButton="papyrus"
        (click)="sendQuickMessage('Please review the current file for potential improvements.')"
        [disabled]="isStreaming()"
        class="!text-xs sm:!text-sm !px-2 sm:!px-3 !py-1 !min-h-8 flex-1 sm:flex-none">
        <lucide-angular [img]="FileTextIcon" class="!w-3 !h-3 sm:!w-4 sm:!h-4 mr-1"></lucide-angular>
        <span class="hidden sm:inline">Review Code</span>
        <span class="sm:hidden">Review</span>
      </button>

      <button mat-stroked-button
        size="small" 
        egyptianButton="papyrus"
        (click)="sendQuickMessage('Generate comprehensive unit tests for the current file.')"
        [disabled]="isStreaming()"
        class="!text-xs sm:!text-sm !px-2 sm:!px-3 !py-1 !min-h-8 flex-1 sm:flex-none">
        <lucide-angular [img]="ZapIcon" class="!w-3 !h-3 sm:!w-4 sm:!h-4 mr-1"></lucide-angular>
        <span class="hidden sm:inline">Generate Tests</span>
        <span class="sm:hidden">Tests</span>
      </button>

      <button mat-stroked-button
        size="small"
        egyptianButton="papyrus"
        (click)="sendQuickMessage('Analyze the current code for potential bugs and issues.')"
        [disabled]="isStreaming()"
        class="!text-xs sm:!text-sm !px-2 sm:!px-3 !py-1 !min-h-8 flex-1 sm:flex-none">
        <lucide-angular [img]="CodeIcon" class="!w-3 !h-3 sm:!w-4 sm:!h-4 mr-1"></lucide-angular>
        <span class="hidden sm:inline">Find Bugs</span>
        <span class="sm:hidden">Bugs</span>
      </button>

      <button mat-stroked-button
        size="small"
        egyptianButton="papyrus"
        (click)="sendQuickMessage('Add comprehensive documentation to the current code.')"
        [disabled]="isStreaming()"
        class="!text-xs sm:!text-sm !px-2 sm:!px-3 !py-1 !min-h-8 flex-1 sm:flex-none hidden sm:inline-flex">
        <mat-icon class="!text-base mr-1">description</mat-icon>
        Add Docs
      </button>

      <button mat-stroked-button
        size="small"
        egyptianButton="papyrus"
        (click)="sendQuickMessage('Suggest performance optimizations for the current code.')"
        [disabled]="isStreaming()"
        class="!text-xs sm:!text-sm !px-2 sm:!px-3 !py-1 !min-h-8 flex-1 sm:flex-none hidden sm:inline-flex">
        <mat-icon class="!text-base mr-1">speed</mat-icon>
        Optimize
      </button>
    </div>
  </div>
</div>
