<!-- VS Code Style Chat Interface -->
<div class="flex flex-col h-screen vscode-bg vscode-fg">
  <!-- Header with Session Info and Actions -->
  <header class="flex items-center justify-between px-4 py-2 vscode-border border-b border-solid">
    <div class="flex-1">
      <h3 class="text-sm font-medium vscode-fg">
        {{ currentSession()?.name || 'New Session' }}
      </h3>
      @if (workspaceInfo()) {
        <div class="text-xs vscode-description mt-1">
          {{ workspaceInfo()!.name }} â€¢ {{ workspaceInfo()!.projectType }}
        </div>
      }
    </div>

    <div class="flex items-center gap-1">
      <app-egyptian-button
        [iconData]="PlusIcon"
        [iconOnly]="true"
        size="sm"
        tooltip="New Session"
        (clicked)="newSession()">
      </app-egyptian-button>

      <app-egyptian-button
        [iconData]="HistoryIcon"
        [iconOnly]="true"
        size="sm"
        tooltip="Switch Session"
        (clicked)="switchSession()">
      </app-egyptian-button>

      <app-egyptian-button
        [iconData]="SettingsIcon"
        [iconOnly]="true"
        size="sm"
        tooltip="Chat Settings"
        (clicked)="showSettings()">
      </app-egyptian-button>
    </div>
  </header>

  <!-- Token Usage Progress Bar -->
  @if (currentSession()?.tokenUsage) {
    <div class="h-1 vscode-bg overflow-hidden">
      <div
        class="h-full transition-all duration-300 ease-out"
        [style.width.%]="currentSession()!.tokenUsage!.percentage"
        [class]="currentSession()!.tokenUsage!.percentage > 90 ? 'bg-red-500' : 
                 currentSession()!.tokenUsage!.percentage > 80 ? 'bg-yellow-500' : 
                 'bg-blue-500'">
      </div>
    </div>
  }

  <!-- Messages Area -->
  <main class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
    @if (isLoading()) {
      <div class="flex flex-col items-center justify-center h-full text-center space-y-4">
        <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="vscode-description text-sm">Initializing Claude...</p>
      </div>
    } @else if (messages().length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-center space-y-6">
        <div class="text-6xl opacity-50">ðŸ¦˜</div>
        <div class="space-y-2">
          <h3 class="text-lg font-medium vscode-fg">Generate, refactor, and debug code with AI assistance.</h3>
          <p class="vscode-description text-sm max-w-md">Check out our <span class="text-blue-400 cursor-pointer">documentation</span> to learn more.</p>
        </div>
        
        <div class="space-y-4">
          <div class="flex items-center gap-3 text-left">
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0">
              <lucide-angular [img]="CodeIcon" class="w-4 h-4 text-blue-400"></lucide-angular>
            </div>
            <div>
              <p class="text-blue-400 text-sm font-medium">Customizable Modes:</p>
              <p class="vscode-description text-xs">Specialized personas with their own behaviors and assigned models</p>
            </div>
          </div>
          
          <div class="flex items-center gap-3 text-left">
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0">
              <lucide-angular [img]="ZapIcon" class="w-4 h-4 text-blue-400"></lucide-angular>
            </div>
            <div>
              <p class="text-blue-400 text-sm font-medium">Task Orchestration:</p>
              <p class="vscode-description text-xs">Split tasks into smaller, manageable parts</p>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-center max-w-md">
          <button 
            class="inline-flex items-center gap-2 px-3 py-2 text-xs rounded-md vscode-button-bg vscode-button-fg hover:vscode-button-hover transition-colors duration-200"
            (click)="sendQuickMessage('Please review the current file for potential improvements.')">
            <lucide-angular [img]="CodeIcon" class="w-3 h-3"></lucide-angular>
            Review Code
          </button>

          <button 
            class="inline-flex items-center gap-2 px-3 py-2 text-xs rounded-md vscode-button-bg vscode-button-fg hover:vscode-button-hover transition-colors duration-200"
            (click)="sendQuickMessage('Generate unit tests for the current file.')">
            <lucide-angular [img]="FlaskConicalIcon" class="w-3 h-3"></lucide-angular>
            Generate Tests
          </button>

          <button 
            class="inline-flex items-center gap-2 px-3 py-2 text-xs rounded-md vscode-button-bg vscode-button-fg hover:vscode-button-hover transition-colors duration-200"
            (click)="sendQuickMessage('Find potential bugs and issues in the current code.')">
            <lucide-angular [img]="SearchIcon" class="w-3 h-3"></lucide-angular>
            Find Bugs
          </button>
        </div>
      </div>
    } @else {
      @for (message of messages(); track message.id) {
        <div class="space-y-1">
          @if (message.type === 'user') {
            <div class="flex justify-end">
              <div class="max-w-[80%] bg-blue-600 text-white rounded-lg px-4 py-2 ml-12">
                <div class="text-sm break-words leading-relaxed" [innerHTML]="formatMessageContent(message.content)"></div>

                @if (message.files && message.files.length > 0) {
                  <div class="mt-2 flex flex-wrap gap-1">
                    @for (file of message.files; track file) {
                      <div class="inline-flex items-center gap-1 px-2 py-1 bg-blue-700 rounded text-xs">
                        <lucide-angular [img]="FileIcon" class="w-3 h-3"></lucide-angular>
                        {{ getFileName(file) }}
                      </div>
                    }
                  </div>
                }

                <div class="text-xs opacity-75 text-right mt-2">
                  {{ formatTimestamp(message.timestamp) }}
                </div>
              </div>
            </div>
          } @else if (message.type === 'assistant') {
            <div class="flex justify-start">
              <div class="max-w-[80%] vscode-border border rounded-lg px-4 py-3 mr-12"
                   [class]="message.isError ? 'border-red-500 bg-red-500/10' : 'border-gray-600 vscode-bg'">
                <div class="text-sm break-words leading-relaxed vscode-fg" [innerHTML]="formatMessageContent(message.content)"></div>

                @if (message.streaming) {
                  <div class="flex items-center gap-2 mt-3">
                    <div class="flex gap-1">
                      <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                      <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                      <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    </div>
                    <span class="text-xs vscode-description">Claude is thinking...</span>
                  </div>
                }

                <div class="text-xs vscode-description text-left mt-2">
                  {{ formatTimestamp(message.timestamp) }}
                </div>
              </div>
            </div>
          } @else {
            <div class="flex justify-center">
              <div class="max-w-[60%] px-3 py-2 rounded-md text-center"
                   [class]="message.isError ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'">
                <div class="text-xs">{{ message.content }}</div>
              </div>
            </div>
          }
        </div>
      }
    }

    @if (isStreaming()) {
      <div class="flex justify-start">
        <div class="max-w-[80%] vscode-border border border-gray-600 rounded-lg px-4 py-3 mr-12 vscode-bg">
          <div class="flex items-center gap-2">
            <div class="flex gap-1">
              <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
              <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
              <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
            </div>
            <span class="text-xs vscode-description">Claude is thinking...</span>
          </div>
        </div>
      </div>
    }
  </main>

  <!-- Bottom Input Area -->
  <footer class="border-t vscode-border border-solid">
    <!-- Auto-approve indicator and context -->
    <div class="px-4 py-2 text-xs vscode-description flex items-center gap-4">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded border border-gray-600 flex items-center justify-center">
          <div class="w-2 h-2 bg-green-500 rounded-sm"></div>
        </div>
        <span>Auto-approve: Read</span>
      </div>
      
      @if (workspaceInfo()) {
        <div class="flex items-center gap-2 text-xs">
          <span>(@ to add context, / for commands, hold shift to drag in files)</span>
        </div>
      }
    </div>

    <!-- Main input container -->
    <div class="p-4">
      <div class="relative vscode-input-bg vscode-input-border border rounded-lg">
        <app-egyptian-input
          [(ngModel)]="currentMessage"
          placeholder="Type your task here..."
          [disabled]="isStreaming()"
          [multiline]="true"
          [rows]="1"
          (keyDown)="onKeyDown($event)"
          class="border-0 bg-transparent">
        </app-egyptian-input>

        <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
          <app-egyptian-button
            [iconData]="isStreaming() ? RefreshCwIcon : SendIcon"
            [iconOnly]="true"
            size="sm"
            tooltip="Send Message"
            [disabled]="!canSendMessage()"
            (clicked)="sendMessage()">
          </app-egyptian-button>
        </div>
      </div>

      <!-- Quick action buttons -->
      <div class="flex items-center gap-2 mt-3">
        <app-egyptian-button
          [iconData]="FileTextIcon"
          [iconOnly]="true"
          size="sm"
          tooltip="Review Code"
          [disabled]="isStreaming()"
          (clicked)="sendQuickMessage('Please review the current file for potential improvements.')">
        </app-egyptian-button>

        <app-egyptian-button
          [iconData]="FlaskConicalIcon"
          [iconOnly]="true"
          size="sm"
          tooltip="Generate Tests"
          [disabled]="isStreaming()"
          (clicked)="sendQuickMessage('Generate comprehensive unit tests for the current file.')">
        </app-egyptian-button>

        <app-egyptian-button
          [iconData]="SearchIcon"
          [iconOnly]="true"
          size="sm"
          tooltip="Find Bugs"
          [disabled]="isStreaming()"
          (clicked)="sendQuickMessage('Analyze the current code for potential bugs and issues.')">
        </app-egyptian-button>

        <app-egyptian-button
          [iconData]="BookOpenIcon"
          [iconOnly]="true"
          size="sm"
          tooltip="Add Documentation"
          [disabled]="isStreaming()"
          (clicked)="sendQuickMessage('Add comprehensive documentation to the current code.')">
        </app-egyptian-button>

        <app-egyptian-button
          [iconData]="TrendingUpIcon"
          [iconOnly]="true"
          size="sm"
          tooltip="Optimize Performance"
          [disabled]="isStreaming()"
          (clicked)="sendQuickMessage('Suggest performance optimizations for the current code.')">
        </app-egyptian-button>
      </div>
    </div>
  </footer>
</div>
