<div class="context-tree-container h-full flex flex-col">
  <!-- Header with statistics -->
  <app-egyptian-card
    title="Project Context"
    subtitle="Manage files included in Claude context"
    variant="compact"
    class="mb-4"
  >
    <div class="flex justify-between items-center mb-4" slot="content">
      <div class="stats flex gap-4 text-sm">
        <span class="token-info">
          <strong>{{ currentTokens() }}</strong> / {{ maxTokens() }} tokens
        </span>
        <span class="file-count text-hieroglyph-600">
          {{ includedFilesCount() }} files included
        </span>
      </div>

      <div class="actions flex gap-2">
        <app-egyptian-button
          (clicked)="refreshContext()"
          [disabled]="isLoading()"
          size="sm"
          variant="secondary"
        >
          @if (isLoading()) {
            <app-loading-spinner size="sm" />
          } @else {
            Refresh
          }
        </app-egyptian-button>

        <app-egyptian-button
          (clicked)="clearAll()"
          [disabled]="isLoading() || includedFilesCount() === 0"
          size="sm"
          variant="tertiary"
        >
          Clear All
        </app-egyptian-button>
      </div>
    </div>

    <!-- Token usage bar -->
    <div class="token-usage-bar mb-4">
      <div class="bg-papyrus-200 rounded-full h-2 overflow-hidden">
        <div
          class="h-full transition-all duration-300"
          [class]="tokenUsageBarClass()"
          [style.width.%]="tokenUsagePercentage()"
        ></div>
      </div>

      @if (tokenWarning()) {
        <div class="mt-2 p-2 rounded-egyptian text-sm" [class]="tokenWarningClass()">
          <strong>{{ tokenWarning()!.level | titlecase }}:</strong> {{ tokenWarning()!.message }}
          @if (tokenWarning()!.suggestion) {
            <br /><em>{{ tokenWarning()!.suggestion }}</em>
          }
        </div>
      }
    </div>
  </app-egyptian-card>

  <!-- File tree -->
  <app-egyptian-card title="File Tree" variant="default" class="flex-1 overflow-hidden">
    <div class="tree-container overflow-auto h-full" slot="content">
      @if (isLoading()) {
        <div class="flex items-center justify-center h-32">
          <app-loading-spinner message="Loading workspace files..." />
        </div>
      } @else if (error()) {
        <div class="error-state text-center text-red-600 p-4">
          <div class="text-lg font-semibold mb-2">Error loading files</div>
          <div class="text-sm mb-4">{{ error() }}</div>
          <app-egyptian-button (clicked)="refreshContext()" size="sm">
            Try Again
          </app-egyptian-button>
        </div>
      } @else if (filteredFiles().length === 0) {
        <div class="empty-state text-center text-hieroglyph-600 p-8">
          <div class="text-lg font-semibold mb-2">No files found</div>
          <div class="text-sm">Your workspace appears to be empty or no files are accessible.</div>
        </div>
      } @else {
        <div class="file-tree">
          @for (file of filteredFiles(); track file.path) {
            <div
              class="file-node"
              [class.selected]="selectedFiles().has(file.path)"
              [style.margin-left.px]="file.depth * 20"
            >
              <div
                class="node-content flex items-center py-1 px-2 hover:bg-papyrus-100 rounded transition-colors"
              >
                <!-- Expand/collapse button for directories -->
                @if (file.type === 'directory') {
                  <button
                    class="expand-button w-4 h-4 mr-2 flex items-center justify-center text-hieroglyph-600 hover:text-hieroglyph-800"
                    (click)="toggleDirectory(file.path)"
                    [attr.aria-label]="
                      expandedFolders().has(file.path) ? 'Collapse folder' : 'Expand folder'
                    "
                  >
                    @if (expandedFolders().has(file.path)) {
                      ‚ñº
                    } @else {
                      ‚ñ∂
                    }
                  </button>
                } @else {
                  <div class="w-4 h-4 mr-2"></div>
                }

                <!-- File/folder icon -->
                <div class="icon mr-2 text-sm">
                  @if (file.type === 'directory') {
                    üìÅ
                  } @else {
                    üìÑ
                  }
                </div>

                <!-- File name -->
                <div class="file-name flex-1 text-sm font-medium">
                  {{ file.name }}
                </div>

                <!-- Inclusion status -->
                <div class="inclusion-status flex items-center gap-2 ml-2">
                  @if (file.type === 'file') {
                    <!-- Token estimate -->
                    @if (file.tokenEstimate) {
                      <span class="token-estimate text-xs text-hieroglyph-500">
                        {{ file.tokenEstimate }} tokens
                      </span>
                    }

                    <!-- Inclusion toggle -->
                    <button
                      class="inclusion-toggle w-5 h-5 rounded border-2 flex items-center justify-center transition-all"
                      [class]="getInclusionToggleClass(file)"
                      (click)="toggleFileInclusion(file.path)"
                      [attr.aria-label]="getInclusionToggleLabel(file)"
                    >
                      @if (file.isIncluded) {
                        ‚úì
                      }
                    </button>
                  }
                </div>

                <!-- Context menu trigger -->
                <button
                  class="context-menu-trigger w-6 h-6 ml-2 text-hieroglyph-400 hover:text-hieroglyph-600 opacity-0 group-hover:opacity-100 transition-opacity"
                  (click)="showContextMenu($event, file)"
                  [attr.aria-label]="'More options for ' + file.name"
                >
                  ‚ãØ
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </app-egyptian-card>

  <!-- Context menu (simplified - just show actions) -->
  @if (contextMenuFile() && showContextMenuFlag()) {
    <div
      class="context-menu fixed z-50 bg-white border border-papyrus-300 rounded-egyptian shadow-lg py-2 min-w-48"
      [style.left.px]="contextMenuPosition().x"
      [style.top.px]="contextMenuPosition().y"
    >
      @if (contextMenuFile()!.type === 'file') {
        @if (!contextMenuFile()!.isIncluded) {
          <button
            class="menu-item w-full text-left px-4 py-2 hover:bg-papyrus-100 text-sm"
            (click)="includeFileFromMenu()"
          >
            Include in Context
          </button>
        } @else {
          <button
            class="menu-item w-full text-left px-4 py-2 hover:bg-papyrus-100 text-sm"
            (click)="excludeFileFromMenu()"
          >
            Exclude from Context
          </button>
        }
      }

      @if (contextMenuFile()!.type === 'directory') {
        <button
          class="menu-item w-full text-left px-4 py-2 hover:bg-papyrus-100 text-sm"
          (click)="includeDirectoryFromMenu()"
        >
          Include All Files
        </button>
        <button
          class="menu-item w-full text-left px-4 py-2 hover:bg-papyrus-100 text-sm"
          (click)="excludeDirectoryFromMenu()"
        >
          Exclude All Files
        </button>
      }

      <hr class="my-1 border-papyrus-200" />
      <button
        class="menu-item w-full text-left px-4 py-2 hover:bg-papyrus-100 text-sm text-hieroglyph-600"
        (click)="hideContextMenu()"
      >
        Cancel
      </button>
    </div>
  }
</div>
